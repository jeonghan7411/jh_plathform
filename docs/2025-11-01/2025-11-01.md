# 작업 로그 - 2025년 11월 1일

## 📋 작업 개요
오늘은 JWT 필터 기반 자동 인증 시스템을 구축하고, 프론트엔드에서 로그인 상태에 따른 자동 리다이렉트 기능을 구현했습니다.

---

## 🔧 주요 작업 내용

### 1. JWT 필터 기반 자동 인증 시스템 구축 (백엔드)

#### 1.1 JwtAuthenticationFilter 생성
**파일**: `auth/auth/src/main/java/jh_platform/auth/config/JwtAuthenticationFilter.java`

- **목적**: 모든 요청에서 쿠키의 JWT 토큰을 자동으로 검증하고 인증 정보 설정
- **기능**:
  - HttpOnly Cookie에서 `accessToken` 추출
  - 토큰 유효성 검증 (`JwtTokenProvider.validateToken()`)
  - 유효한 토큰이면 `SecurityContext`에 인증 정보 설정
  - `UsernamePasswordAuthenticationToken` 생성 및 권한 부여 (`ROLE_USER`)

```java
@Override
protected void doFilterInternal(
        HttpServletRequest request,
        HttpServletResponse response,
        FilterChain filterChain
) throws ServletException, IOException {
    String token = extractTokenFromCookie(request);
    
    if (token != null && jwtTokenProvider.validateToken(token)) {
        String username = jwtTokenProvider.getUsername(token);
        
        UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(
                        username,
                        null,
                        Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"))
                );
        
        SecurityContextHolder.getContext().setAuthentication(authentication);
    }
    
    filterChain.doFilter(request, response);
}
```

#### 1.2 SecurityConfig 수정
**파일**: `auth/auth/src/main/java/jh_platform/auth/config/SecurityConfig.java`

- **변경 사항**:
  - JWT 필터를 필터 체인에 추가 (`addFilterBefore()`)
  - `/api/auth/signup`, `/api/auth/login`만 `permitAll()` 설정
  - 나머지 모든 경로는 `authenticated()`로 설정 (JWT 필터에서 자동 검증)

```java
.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)
.authorizeHttpRequests(authz -> authz
    .requestMatchers("/api/auth/signup", "/api/auth/login").permitAll()
    .anyRequest().authenticated()
)
```

#### 1.3 AuthController 수정
**파일**: `auth/auth/src/main/java/jh_platform/auth/controller/AuthController.java`

- **변경 사항**:
  - `getUserInfo()` 메서드에서 쿠키에서 직접 토큰 추출 로직 제거
  - `SecurityContext`에서 인증 정보 가져오기로 변경
  - JWT 필터에서 이미 인증 처리가 완료되었으므로 간소화

```java
@GetMapping("/user")
public ApiResponse<User> getUserInfo() {
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    
    if (authentication == null || !authentication.isAuthenticated()) {
        return ApiResponse.error(401, "인증되지 않은 사용자입니다.");
    }
    
    String username = authentication.getName();
    User user = authService.getUserInfo(username);
    
    return ApiResponse.success(user);
}
```

#### 1.4 필터 체인 실행 순서
```
요청 → JWT 필터 (토큰 검증 및 SecurityContext 설정) 
    → FilterSecurityInterceptor (권한 체크) 
    → 컨트롤러
```

---

### 2. ReturnPage 컴포넌트 생성 (프론트엔드)

#### 2.1 ReturnPage.js 생성
**파일**: `portal/portal_fronted/src/pages/main/ReturnPage.js`

- **목적**: 로그인이 필요한 페이지에 표시할 컴포넌트
- **기능**:
  - 로그인 페이지로 이동 버튼
  - 회원가입 페이지로 이동 버튼
  - 모던한 UI 디자인 (그라데이션 배경, 애니메이션)

#### 2.2 ReturnPage.css 생성
**파일**: `portal/portal_fronted/src/pages/main/ReturnPage.css`

- 반응형 디자인 (모바일 대응)
- 부드러운 애니메이션 효과
- 일관된 색상 체계 (파란색 계열)

---

### 3. 인증 상태 기반 자동 리다이렉트 구현 (프론트엔드)

#### 3.1 LoginPage 수정
**파일**: `portal/portal_fronted/src/pages/login/LoginPage.js`

- **변경 사항**:
  - Zustand에서 `user` 상태 확인
  - 사용자 정보가 있으면 `/main`으로 자동 리다이렉트
  - 서버 호출 없이 로컬 상태만 확인 (성능 최적화)

```javascript
useEffect(() => {
    if (user) {
        navigate('/main', { replace: true });
    }
}, [user, navigate]);
```

#### 3.2 SignupPage 수정
**파일**: `portal/portal_fronted/src/pages/Signup/SignupPage.js`

- LoginPage와 동일한 로직 적용
- 이미 로그인되어 있으면 회원가입 페이지 접근 시 `/main`으로 리다이렉트

---

## 💡 핵심 개선 사항

### 1. 자동 인증 시스템
- **이전**: 각 API에서 개별적으로 토큰 검증 (`permitAll()`에 경로 추가 필요)
- **개선**: JWT 필터에서 모든 요청 자동 검증 (새 API 추가 시 별도 설정 불필요)

### 2. 확장성 향상
- API가 늘어나도 `SecurityConfig`에 경로 추가 불필요
- JWT 필터에서 자동으로 모든 요청 검증
- 컨트롤러 코드 간소화 (토큰 검증 로직 제거)

### 3. 성능 최적화
- LoginPage/SignupPage에서 불필요한 서버 호출 제거
- Zustand 로컬 상태만 확인하여 즉시 리다이렉트
- 사용자 정보는 필요할 때만 HomePage에서 조회

### 4. 보안 강화
- 모든 요청이 JWT 필터를 통과하여 일관된 인증 처리
- SecurityContext를 통한 중앙화된 인증 관리

---

## 🔄 동작 흐름

### 로그인 흐름
```
1. 사용자 로그인 요청
2. AuthController.login() → 토큰 생성 + HttpOnly Cookie 설정
3. LoginForm에서 onLoginSuccess() 호출
4. /main으로 이동
5. HomePage에서 사용자 정보 조회 (refetchUser)
6. Zustand에 사용자 정보 저장
```

### 인증이 필요한 API 호출
```
1. 클라이언트 요청 (쿠키 자동 포함)
2. JWT 필터: 쿠키에서 토큰 추출 및 검증
3. 유효하면 SecurityContext에 인증 정보 설정
4. FilterSecurityInterceptor: authenticated() 체크
5. 통과 → 컨트롤러 실행
```

### 로그인 상태 확인 (LoginPage/SignupPage)
```
1. 페이지 마운트
2. Zustand에서 user 확인
3. 있으면 → /main으로 리다이렉트 (서버 호출 없음)
4. 없으면 → 로그인/회원가입 폼 표시
```

---

## 📁 변경된 파일 목록

### 백엔드
- ✅ `auth/auth/src/main/java/jh_platform/auth/config/JwtAuthenticationFilter.java` (신규)
- ✅ `auth/auth/src/main/java/jh_platform/auth/config/SecurityConfig.java` (수정)
- ✅ `auth/auth/src/main/java/jh_platform/auth/controller/AuthController.java` (수정)

### 프론트엔드
- ✅ `portal/portal_fronted/src/pages/main/ReturnPage.js` (신규)
- ✅ `portal/portal_fronted/src/pages/main/ReturnPage.css` (신규)
- ✅ `portal/portal_fronted/src/pages/login/LoginPage.js` (수정)
- ✅ `portal/portal_fronted/src/pages/Signup/SignupPage.js` (수정)

---

## 🎯 다음 작업 예정 사항

1. 토큰 갱신 (Refresh Token) 기능 구현
2. 권한별 접근 제어 (ROLE 기반)
3. 로딩 상태 개선 (스피너 또는 스켈레톤 UI)
4. 에러 처리 개선 (토큰 만료 시 자동 로그아웃)

---

## 📝 참고 사항

- JWT 필터는 `UsernamePasswordAuthenticationFilter` 이전에 실행됨
- HttpOnly Cookie 사용으로 XSS 공격 방지
- `replace: true` 옵션으로 브라우저 히스토리 관리
- Zustand persist 미들웨어로 사용자 정보 로컬 스토리지 저장

